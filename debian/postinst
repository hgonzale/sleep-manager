#!/bin/sh
set -e

if ! id sleep-manager >/dev/null 2>&1; then
    useradd --system --user-group --shell /bin/false --home-dir /usr/lib/sleep-manager sleep-manager
fi

version_arg="$(dpkg-query -W -f='${Version}' sleep-manager 2>/dev/null || true)"
if [ -z "$version_arg" ]; then
    version_arg="${2:-}"
fi
version_arg="${version_arg#*:}"
version_arg="${version_arg%%-*}"
if [ -n "$version_arg" ]; then
    export HATCH_VCS_VERSION="$version_arg"
    export SETUPTOOLS_SCM_PRETEND_VERSION="$version_arg"
fi

mkdir -p /etc/sleep-manager
chown -R sleep-manager:sleep-manager /usr/lib/sleep-manager
chmod 755 /usr/lib/sleep-manager

needs_reenable=0
for unit in sleep-manager.service sleep-manager-sleeper.service sleep-manager-waker.service sleep-manager-delay.service; do
    if [ -d "/lib/systemd/system/$unit" ] && [ -f "/lib/systemd/system/$unit/$unit" ]; then
        mv "/lib/systemd/system/$unit/$unit" "/lib/systemd/system/$unit.tmp"
        rm -rf "/lib/systemd/system/$unit"
        mv "/lib/systemd/system/$unit.tmp" "/lib/systemd/system/$unit"
        needs_reenable=1
    fi
    if [ -f "/etc/systemd/system/$unit" ]; then
        if grep -q "/usr/local/sleep-manager" "/etc/systemd/system/$unit"; then
            mv "/etc/systemd/system/$unit" "/etc/systemd/system/${unit}.bak"
            needs_reenable=1
        fi
    fi
    if [ -d "/etc/systemd/system/${unit}.d" ]; then
        if grep -R -q "/usr/local/sleep-manager" "/etc/systemd/system/${unit}.d" 2>/dev/null; then
            mv "/etc/systemd/system/${unit}.d" "/etc/systemd/system/${unit}.d.bak"
            needs_reenable=1
        fi
    fi
done

for unit in sleep-manager-sleeper.service sleep-manager-waker.service; do
    if systemctl is-enabled "$unit" >/dev/null 2>&1; then
        systemctl stop "$unit" >/dev/null 2>&1 || true
        systemctl disable "$unit" >/dev/null 2>&1 || true
    fi
    if [ -f "/etc/systemd/system/$unit" ]; then
        rm -f "/etc/systemd/system/$unit"
        needs_reenable=1
    fi
done

if [ -f /etc/sleep-manager/sleep-manager-config.toml ]; then
    chown root:sleep-manager /etc/sleep-manager/sleep-manager-config.toml
    chmod 0640 /etc/sleep-manager/sleep-manager-config.toml
fi
if [ -f /etc/sleep-manager/sleep-manager-config.json ] && \
   [ ! -f /etc/sleep-manager/sleep-manager-config.toml ]; then
    python3 - <<'PY' || true
import json
from pathlib import Path

src = Path("/etc/sleep-manager/sleep-manager-config.json")
dest = Path("/etc/sleep-manager/sleep-manager-config.toml")
data = json.loads(src.read_text())

lines = []
common = {}
if isinstance(data.get("COMMON"), dict):
    common = data["COMMON"]
else:
    for key in ("DOMAIN", "PORT", "DEFAULT_REQUEST_TIMEOUT", "API_KEY"):
        if key in data:
            common[key] = data[key]

role = None
if isinstance(common.get("ROLE"), str):
    role = common["ROLE"]
elif isinstance(data.get("ROLE"), str):
    role = data["ROLE"]
elif "WAKER" in data and "SLEEPER" not in data:
    role = "waker"
elif "SLEEPER" in data and "WAKER" not in data:
    role = "sleeper"

if role is None:
    print(
        "WARNING: Unable to infer COMMON.ROLE from legacy JSON config; "
        "please set COMMON.ROLE to 'waker' or 'sleeper'."
    )
else:
    common["ROLE"] = role

lines.append("[COMMON]")
for key, value in common.items():
    if isinstance(value, str):
        lines.append(f'{key} = "{value}"')
    elif isinstance(value, bool):
        lines.append(f"{key} = {'true' if value else 'false'}")
    else:
        lines.append(f"{key} = {value}")
lines.append("")

for section in ("WAKER", "SLEEPER"):
    section_data = data.get(section)
    if not isinstance(section_data, dict):
        continue
    lines.append(f"[{section}]")
    for skey, svalue in section_data.items():
        if isinstance(svalue, str):
            lines.append(f'{skey} = "{svalue}"')
        elif isinstance(svalue, bool):
            lines.append(f"{skey} = {'true' if svalue else 'false'}")
        else:
            lines.append(f"{skey} = {svalue}")
    lines.append("")

dest.write_text("\n".join(lines).strip() + "\n")
PY
    chown root:sleep-manager /etc/sleep-manager/sleep-manager-config.toml
    chmod 0640 /etc/sleep-manager/sleep-manager-config.toml
fi

if [ -f /etc/sudoers.d/sleep-manager ]; then
    chown root:root /etc/sudoers.d/sleep-manager
    chmod 0440 /etc/sudoers.d/sleep-manager
fi

if [ ! -d /usr/lib/sleep-manager/venv ]; then
    python3 -m venv /usr/lib/sleep-manager/venv
fi

chown -R sleep-manager:sleep-manager /usr/lib/sleep-manager/venv

/usr/lib/sleep-manager/venv/bin/pip install --upgrade pip setuptools wheel
/usr/lib/sleep-manager/venv/bin/pip install --upgrade hatchling hatch-vcs
/usr/lib/sleep-manager/venv/bin/pip install --upgrade --no-build-isolation /usr/lib/sleep-manager

if [ "$needs_reenable" -eq 1 ]; then
    systemctl daemon-reload >/dev/null 2>&1 || true
    for unit in sleep-manager.service sleep-manager-delay.service; do
        if systemctl is-enabled "$unit" >/dev/null 2>&1; then
            systemctl reenable "$unit" >/dev/null 2>&1 || true
        fi
    done
fi
systemctl daemon-reload >/dev/null 2>&1 || true

exit 0
