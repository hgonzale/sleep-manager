[tox]
requires =
    tox>=4.14.0
    tox-uv>=1.11.0
toxworkdir = build/.tox
env_list =
    test
    lint
    typecheck
    gunicorn

[testenv:test]
description = Run the test suite with the default interpreter
runner = uv-venv-runner
dependency_groups = dev
setenv =
    PYTEST_ADDOPTS = -o cache_dir=build/.pytest_cache
commands =
    pytest {posargs:tests}

[testenv:lint]
description = Run Ruff lint checks
runner = uv-venv-runner
dependency_groups = dev
setenv =
    RUFF_CACHE_DIR = build/.ruff_cache
commands =
    ruff check {posargs:.}

[testenv:typecheck]
description = Run ty type checks
runner = uv-venv-runner
dependency_groups = dev
commands =
    ty check {posargs:sleep_manager tests}

[testenv:gunicorn]
description = Gunicorn smoke tests (startup, HTTP, log format, clean shutdown)
runner = uv-venv-runner
dependency_groups = dev
setenv =
    PYTEST_ADDOPTS = -o cache_dir=build/.pytest_cache
commands =
    pytest -m gunicorn --no-cov {posargs:tests}

[testenv:deps]
description = Regenerate uv.lock and requirements.txt (run after changing dependencies)
runner = uv-venv-runner
skip_install = true
commands =
    uv lock
    uv export --no-dev --no-emit-project --format requirements-txt --output-file requirements.txt

[testenv:docs]
description = Build the Sphinx documentation
runner = uv-venv-runner
dependency_groups = docs
commands =
    python -m sphinx -b html docs build/docs/html

[testenv:clean]
description = Remove build/test artifacts
runner = uv-venv-runner
skip_install = true
commands =
    python -c "import glob, shutil, os; paths=['build','dist']; [shutil.rmtree(p, ignore_errors=True) for p in paths]; [shutil.rmtree(p, ignore_errors=True) for p in glob.glob('*.egg-info')]; [shutil.rmtree(p, ignore_errors=True) for p in glob.glob('**/__pycache__', recursive=True)]; [shutil.rmtree(p, ignore_errors=True) for p in glob.glob('**/*.pyc', recursive=True)]; os.remove('.coverage') if os.path.exists('.coverage') else None"
